<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HYDROMATIC</title>
    <!-- Tailwind CSS for styling -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
    <!-- SweetAlert2 for alerts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.9/sweetalert2.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.9/sweetalert2.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css?family=Karla:400,700&display=swap');

        .font-family-karla {
            font-family: 'poppins', sans-serif;
        }

        .bg-sidebar {
            background: #1f272b;
        }

        .cta-btn {
            color: #000000;
        }

        .absolute {
            background: #099627;
        }

        .a:hover {
            background: #06641b;
        }

        .upgrade-btn:hover {
            background: #000000;
        }

        .b {
            border-color: #15cc15;
        }
        .active-nav-link {
            color: #15cc15;
        }

        .nav-item:hover {
            color: #15cc15;
        }

        .bg-c {
            background: rgb(224, 224, 224);
        }

        .account-link:hover {
            background: #000000;
        }

        .custom-shadow {
            box-shadow: 0 4px 8px rgba(0, 29, 7, 0.849), 0 6px 20px rgba(0, 39, 2, 0.342);
        }

        .bg-bed-color {
            background-color: #86efac;
        }

        .bg-body {
            background: #1f272b
        }

        .text1 {
            color: #15cc15;
            /* Green color for "Matic" */
        }

        .text2 {
            color: #FFFF;
            /* Black color for "Hydro" */
        }

        .text-combined {
            display: inline-block;

            font-weight: 700;
        }
    </style>
</head>

<body class="font-family-karla flex flex-col bg-c h-screen">
    <!-- Main container -->
    <div class="w-full flex flex-col h-screen overflow-y-hidden">
        <!-- Header -->
        <header class="w-full bg-sidebar py-5 px-6">
            <div class="container mx-auto flex justify-between items-center">
                <!-- Logo and Branding -->
                <a href="index"
                    class="text-2xl md:text-3xl lg:text-4xl xl:text-5xl uppercase font-family-karla hover:text-green-100 text-combined">
                    <span class="text2">Hydro</span><span class="text1">Matic</span>
                </a>
                <!-- Navigation for Desktop -->
                <nav id="navbar-menu" class="hidden lg:flex space-x-8">
                    <a href="index" class="flex items-center active-nav-link text-white py-2 pl-4 nav-item">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Dashboard
                    </a>
                    <a href="archive" class="flex items-center text-white py-2 pl-4 nav-item">
                        <i class="fas fa-folder mr-3"></i>
                        Archive
                    </a>
                    <a href="settings" class="flex items-center text-white py-2 pl-4 nav-item">
                        <i class="fas fa-cog mr-3"></i>
                        Settings
                    </a>
                    <button id="logout-button" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                        Logout
                    </button>
                </nav>
                <!-- Navigation for Mobile -->
                <button id="navbar-toggler" class="lg:hidden text-gray-100 focus:outline-none"
                    onclick="toggleMobileMenu()">
                    <i class="fas fa-bars fa-2x"></i>
                </button>
            </div>
            <!-- Mobile Navigation Menu -->
            <nav id="mobile-menu" class="flex flex-col pt-4 hidden">
                <a href="index" class="flex items-center text-white py-2 pl-4 nav-item">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard
                </a>
                <a href="archive" class="flex items-center text-white py-2 pl-4 nav-item">
                    <i class="fas fa-folder mr-3"></i>
                    Archive
                </a>
                <a href="settings" class="flex items-center text-white py-2 pl-4 nav-item">
                    <i class="fas fa-cog mr-3"></i>
                    Settings
                </a>
                <button id="mobile-logout" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                    Logout
                </button>
            </nav>
        </header>
        <!-- Body Content -->
        <div class="flex-grow overflow-hidden">
            <div class="w-full h-full overflow-y-auto md:px-4 lg:px-16">
                <main class="w-full h-full p-6">
                    <h1 id="hostname" class="text-4xl text-black pb-6 font-bold uppercase"></h1>
                    <!-- Placeholder for table, days, weather, harvest information, and water level -->
                    <div id="itemContainer"
                        class="w-full h-full grid grid-flow-row grid-cols-1 sm:grid-cols-1 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-5 gap-5 overflow-auto">
                        <!-- Days -->
                        <div
                            class="w-full bg-white border-4 b border-solid rounded-lg shadow-lg p-6 aspect-square">
                            <h1 class="font-bold uppercase text-lg">Days to harvest</h1>
                            <h1 id="days"></h1>
                            <div id="showImage" class="w-full flex flex-col items-center">
                                <!-- Image will be inserted here -->
                            </div>
                            <div id="descriptionContainer" class="w-full mt-4" style="display:none;">
                                <p id="description" class="mt-2 text-gray-600"></p><br>
                                <button id="toggleDescription" class="px-2 py-1 bg-gray-300 text-gray-800 rounded-lg"
                                    style="display:none;">See More</button>
                            </div>
                        </div>
                        <!-- Water Status -->
                        <div
                            class="w-full bg-white border-4 b border-solid rounded-lg shadow-lg p-6 aspect-square">
                            <div class="w-full h-full grid grid-rows-2 items-center justify-center text-center">
                                <div class="space-x-2">
                                    <h1 class="font-bold uppercase text-lg">Water Temperature</h1>
                                    <i class="fas fa-thermometer-half text-5xl"></i>
                                    <h2 id="waterTemp"></h2>
                                </div>
                                <div class="space-x-2">
                                    <h1 class="font-bold uppercase text-lg">Water Level</h1>
                                    <i class="fas fa-tint text-5xl"></i>
                                    <h2 id="waterLevel"></h2>
                                </div>
                            </div>
                            <!-- square container -->
                        </div>
                        <!-- Weather -->
                        <div id="weather"
                            class="w-full bg-white border-4 b border-solid rounded-lg shadow-lg p-6 aspect-square">
                            <!-- Current weather will be injected here -->
                        </div>
                        <!-- Calendar -->
                        <div id="calendar"
                            class="md:col-span-3 lg:col-span-3 xl:col-span-2 w-full bg-white border-4 b border-solid rounded-lg shadow-lg p-6 aspect-square">
                            <div class="grid grid-cols-2 items-center justify-center">
                                <h1 class="font-bold uppercase text-lg pl-6">Calendar</h1>
                                <h3 id="current-year" class="font-bold text-right text-xl pr-6"></h3>
                            </div>
                            <div class="flex items-center justify-between">
                                <button id="prev-month" class="px-2 py-1 bg-gray-300 text-black rounded">Prev</button>
                                <h3 id="current-month" class="font-bold text-center flex-grow"></h3>
                                <button id="next-month" class="px-2 py-1 bg-gray-300 text-black rounded">Next</button>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm">
                                <!-- Day names -->
                                <div class="font-bold">Sun</div>
                                <div class="font-bold">Mon</div>
                                <div class="font-bold">Tue</div>
                                <div class="font-bold">Wed</div>
                                <div class="font-bold">Thu</div>
                                <div class="font-bold">Fri</div>
                                <div class="font-bold">Sat</div>
                            </div>
                            <!-- Calendar days will be inserted here dynamically -->
                            <div id="days-grid" class="grid grid-cols-7 gap-2 mt-2"></div>
                        </div>
                        <!-- Display Table -->
                        <div id="sensorLogs"
                            class="md:col-span-3 lg:col-span-3 xl:col-span-5 w-full bg-white border-4 b border-solid rounded-lg shadow-lg p-6 aspect-square">
                            <!-- table -->
                            <div class="bg-white shadow-md rounded-lg mb-4">
                                <div class="px-6 py-3 border-b border-gray-200 bg-gray-50">
                                    <h2 class="text-lg font-semibold text-gray-700">
                                        <i class="fas fa-table mr-2"></i>
                                        Data Logs
                                    </h2>
                                </div>
                                <!-- Search and Pagination Controls -->
                                <div class="flex grid-col-2 items-start mt-4">
                                    <!-- Pagination Controls -->
                                    <div id="pagination" class="flex w-full pr-5">
                                        <button id="prevPage"
                                            class="w-1/6 px-4 py-2 bg-gray-300 text-gray-800 rounded-l-lg"
                                            disabled>Previous</button>
                                        <span id="pageInfo" class="px-4 py-2 text-gray-800">Page 1</span>
                                        <button id="nextPage"
                                            class="w-1/6 px-4 py-2 bg-gray-300 text-gray-800 rounded-r-lg">Next</button>
                                    </div>
                                    <!-- Search Box -->
                                    <!-- <div class="mb-4 w-2/3 justify-items-end">
                                        <input type="text" id="searchInput" placeholder="Search Data Logs..."
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div> -->
                                </div>
                                <div class="p-6">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Hostname
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Time
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Current Date
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Water Level
                                                    </th>
                                                    <th
                                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Temperature
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataLogsBody" class="bg-white divide-y divide-gray-200">
                                                <!-- Data rows will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <!-- Footer -->
        <footer class="w-full bg-sidebar py-4 px-6 text-white text-center">
            <p>&copy; 2024 HydroMatic. All rights reserved.</p>
        </footer>
    </div>
    <!-- AlpineJS for interactivity -->
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"
        integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
    <!-- JavaScript to toggle mobile menu visibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Toggle mobile menu visibility -->
    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById("mobile-menu");
            mobileMenu.classList.toggle("hidden");
        }
    </script>
    <!-- Bed status -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const varHost = localStorage.getItem('Var_Host');
            const varIp = localStorage.getItem('Var_Ip');

            console.log("Var_Host:", varHost);
            console.log("Var_Ip:", varIp);

            Promise.all([
                fetch('/api/display_table', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        Var_Host: JSON.parse(varHost),
                        Var_Ip: JSON.parse(varIp),
                    }),
                }).then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch device data.");
                    }
                    return response.json();
                }),
                fetch('/api/growthtimeline').then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch growth timeline data.");
                    }
                    return response.json();
                }),
            ]).then(([DeviceData, ImageData]) => {
                console.log("DeviceData:", DeviceData);
                console.log("ImageData:", ImageData);

                if (!DeviceData || DeviceData.length === 0) {
                    throw new Error("No device data available.");
                }

                // Ensure Last_Day is treated as an integer
                const lastDaysValue = parseInt(DeviceData[0].Last_Day, 10);

                // Find the record with the exact Last_Day value
                const Days = DeviceData.find(record => parseInt(record.Last_Day, 10) === lastDaysValue);

                if (!Days) {
                    throw new Error("No matching record found.");
                }

                // Update the "days" element with the final result
                document.getElementById("days").textContent = `${Days.Last_Day} /70`;

                // Find the matching image phase based on the days result
                const imagePhase = ImageData.find(phase => lastDaysValue >= phase.start_day && lastDaysValue <= phase.end_day);

                // Elements for showing image and description
                const showImage = document.getElementById('showImage');
                const descriptionContainer = document.getElementById('descriptionContainer');
                const descriptionElement = document.getElementById('description');
                const toggleButton = document.getElementById('toggleDescription');

                if (imagePhase) {
                    // Create and display the image element
                    const imageElement = document.createElement('img');
                    imageElement.src = imagePhase.image_path ? `${window.location.origin}/${imagePhase.image_path}` : 'http://localhost:3000/img/lettuce7.png';
                    imageElement.alt = "Image for the bed";
                    imageElement.className = 'w-1/2 h-1/2 block mx-auto';

                    // Clear previous image and append the new one
                    showImage.innerHTML = '';
                    showImage.appendChild(imageElement);

                    // Set the description and manage the toggle functionality
                    const fullDescription = imagePhase.description || 'No description available.';
                    const charLimit = 50;

                    descriptionElement.textContent = fullDescription.length > charLimit ? fullDescription.slice(0, charLimit) + '...' : fullDescription;
                    descriptionContainer.style.display = 'block';

                    // Show toggle button only if description is longer than the character limit
                    if (fullDescription.length > charLimit) {
                        toggleButton.style.display = 'inline-block';
                        let isExpanded = false;
                        toggleButton.addEventListener('click', () => {
                            isExpanded = !isExpanded;
                            toggleButton.textContent = isExpanded ? 'See Less' : 'See More';
                            descriptionElement.textContent = isExpanded ? fullDescription : fullDescription.slice(0, charLimit) + '...';
                        });
                    }
                } else {
                    // Display an error if no matching image is found
                    Swal.fire({
                        title: "Error!",
                        text: "No matching image found for the given day.",
                        icon: "error",
                        confirmButtonText: "Close",
                    });
                }
            })

        });
    </script>
    <!-- Water status -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const Hostname = localStorage.getItem("Var_Host");
            const IpAddress = localStorage.getItem("Var_Ip");

            // Check if data exists and is valid
            if (!Hostname || !IpAddress) {
                Swal.fire({
                    title: "Error!",
                    text: "Data is missing from localStorage.",
                    icon: "error",
                    confirmButtonText: "Close",
                });
                return;
            }

            let hostnameData, ipAddressData;

            try {
                hostnameData = JSON.parse(Hostname);
                ipAddressData = JSON.parse(IpAddress);
            } catch (e) {
                Swal.fire({
                    title: "Error!",
                    text: "Data in localStorage is not valid JSON.",
                    icon: "error",
                    confirmButtonText: "Close",
                });
                return;
            }

            // Display the hostname
            document.getElementById("hostname").textContent = hostnameData;

            fetch("/api/send-Data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    Var_Host: hostnameData,
                    Var_Ip: ipAddressData,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log("Success:", data);
                    document.getElementById("waterTemp").textContent = data[0].Var_Temp;
                    document.getElementById("waterLevel").textContent = data[0].Var_WLvl;
                })
                .catch((error) => {
                    console.error("Error:", error);
                });


        });
    </script>
    <!-- Weather -->
    <script>
        const apiKey = 'eb138ac95057191159c149d24e2807a3';
        const city = 'Gapan';
        const weatherForecast = document.getElementById('weather');

        async function fetchWeatherData() {
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${apiKey}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                const weatherCard = `
                    <div class="w-full bg-white md:w-54 mb-10 p-6 flex flex-col items-center">
                        <div class="text-md font-bold flex flex-col items-center text-gray-900 mb-4">
                            <span class="uppercase text-lg">${new Date().toLocaleDateString('en-US', { weekday: 'long' })}</span> 
                            <span class="font-normal text-gray-700 text-sm">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</span>
                        </div>
                        <div class="w-32 h-32 flex items-center justify-center mb-4">
                            <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" alt="Weather icon" class="w-32 h-32">
                        </div>
                        <p class="text-gray-700 mb-2 text-center">${data.weather[0].description}</p>
                        <div class="text-lg lg:text-2xl font-semibold text-gray-900 text-center">
                            ${data.main.temp.toFixed(1)}ยบ<span class="font-normal text-gray-700 mx-1">/</span>${data.main.temp_min.toFixed(1)}ยบ
                        </div>
                    </div>
                `;

                weatherForecast.innerHTML = weatherCard;
            } catch (error) {
                weatherForecast.innerHTML = '<p class="text-red-500 font-semibold">Unable to fetch weather data. Please try again later.</p>';
                console.error('Error fetching weather data:', error);
            }
        }

        fetchWeatherData();

    </script>
    <!-- Table Data logs -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const Hostname = localStorage.getItem("Var_Host");
            const IpAddress = localStorage.getItem("Var_Ip");
            const Start_Date = localStorage.getItem("Start_Date");

            // Check if data exists and is valid
            if (!Hostname || !IpAddress) {
                Swal.fire({
                    title: "Error!",
                    text: "Data is missing from localStorage.",
                    icon: "error",
                    confirmButtonText: "Close",
                });
                return;
            }

            let hostnameData, ipAddressData;

            try {
                hostnameData = JSON.parse(Hostname);
                ipAddressData = JSON.parse(IpAddress);
                startdateData = JSON.parse(Start_Date);
            } catch (e) {
                Swal.fire({
                    title: "Error!",
                    text: "Data in localStorage is not valid JSON.",
                    icon: "error",
                    confirmButtonText: "Close",
                });
                return;
            }

            // Display the hostname
            document.getElementById("hostname").textContent = hostnameData;

            fetch("/api/DataLogs", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    Var_Host: hostnameData,
                    Var_Ip: ipAddressData,
                    Start_Date: startdateData,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log("Success:", data);

                    // Check if data is an array and has elements
                    if (!Array.isArray(data) || data.length === 0) {
                        Swal.fire({
                            title: "No Data",
                            text: "No logs found for the provided criteria.",
                            icon: "info",
                            confirmButtonText: "Close",
                        });
                        return;
                    }

                    // Pagination settings
                    const rowsPerPage = 5;
                    let currentPage = 1;

                    function displayPage(page) {
                        const tableBody = document.getElementById("dataLogsBody");
                        tableBody.innerHTML = '';

                        const start = (page - 1) * rowsPerPage;
                        const end = start + rowsPerPage;
                        const paginatedData = data.slice(start, end);

                        paginatedData.forEach((log) => {
                            const row = document.createElement("tr");

                            row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hostnameData}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.Time_Dev}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(log.Date_Dev)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.Var_WLvl}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.Var_Temp}</td>
            `;

                            tableBody.appendChild(row);
                        });

                        document.getElementById("pageInfo").textContent = `Page ${page}`;
                        document.getElementById("prevPage").disabled = page === 1;
                        document.getElementById("nextPage").disabled = end >= data.length;
                    }

                    // Initial display
                    displayPage(currentPage);

                    // Pagination controls
                    document.getElementById("prevPage").addEventListener("click", () => {
                        if (currentPage > 1) {
                            currentPage--;
                            displayPage(currentPage);
                        }
                    });

                    document.getElementById("nextPage").addEventListener("click", () => {
                        if (currentPage * rowsPerPage < data.length) {
                            currentPage++;
                            displayPage(currentPage);
                        }
                    });
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

        });

        function formatDate(dateString) {
            const date = new Date(dateString);

            if (isNaN(date.getTime())) {
                console.error('Invalid date:', dateString);
                return 'Invalid Date'; // or return a placeholder text
            }

            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const [{ value: month }, , { value: day }, , { value: year }] = formatter.formatToParts(date);
            return `${month}-${day}-${year}`;
        }
    </script>
    <!-- Calendar -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const calendarGrid = document.getElementById('days-grid');
            const currentYear = document.getElementById('current-year');
            const currentMonth = document.getElementById('current-month');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');

            let currentMonthIndex = new Date().getMonth(); // Start with the current month
            let currentYearValue = new Date().getFullYear(); // Start with the current year

            let startDate = null; // Initialize as null
            let harvestDate = null; // Initialize as null

            function generateCalendar(month, year) {
                currentYear.textContent = year;
                currentMonth.textContent = new Date(year, month).toLocaleString('default', { month: 'long' });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

                calendarGrid.innerHTML = '';

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGrid.innerHTML += `<div class="p-2"></div>`;
                }

                for (let day = 1; day <= lastDateOfMonth; day++) {
                    const isToday = day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
                    const isStartDate = startDate && day === startDate.getDate() && month === startDate.getMonth() && year === startDate.getFullYear();
                    const isHarvestDate = harvestDate && day === harvestDate.getDate() && month === harvestDate.getMonth() && year === harvestDate.getFullYear();

                    let dayClass = 'p-2';
                    if (isToday) {
                        dayClass += ' bg-blue-500 text-white font-bold rounded-full';
                    }
                    if (isStartDate) {
                        dayClass += ' bg-green-500 text-white font-bold rounded-full';
                    }
                    if (isHarvestDate) {
                        dayClass += ' bg-red-500 text-white font-bold rounded-full';
                    }

                    calendarGrid.innerHTML += `<div class="${dayClass}">${day}</div>`;
                }
            }

            function updateCalendar() {
                generateCalendar(currentMonthIndex, currentYearValue);
            }

            function fetchDates() {
                const Hostname = localStorage.getItem("Var_Host");
                const IpAddress = localStorage.getItem("Var_Ip");

                console.log('Hostname:', Hostname);
                console.log('IpAddress:', IpAddress);

                let hostnameData, ipAddressData;

                try {
                    hostnameData = JSON.parse(Hostname);
                    ipAddressData = JSON.parse(IpAddress);
                } catch (e) {
                    Swal.fire({
                        title: "Error!",
                        text: "Data in localStorage is not valid JSON.",
                        icon: "error",
                        confirmButtonText: "Close",
                    });
                    return;
                }

                fetch('/api/dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ Var_Host: hostnameData, Var_Ip: ipAddressData })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network response was not ok: ${response.statusText}`);
                        }
                        return response.json(); // Directly expecting JSON here
                    })
                    .then(data => {
                        if (data.length > 0) {
                            console.log('Fetched dates:', data); // Log the fetched dates
                            const { Start_Date, Harvest_Date } = data[0];
                            startDate = new Date(Start_Date);
                            harvestDate = new Date(Harvest_Date);
                            console.log('Start Date:', startDate); // Log the start date
                            console.log('Harvest Date:', harvestDate); // Log the harvest date
                            updateCalendar(); // Update the calendar after fetching data
                        } else {
                            console.error('No data found');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching dates:', error);
                    });
            }

            fetchDates(); // Fetch dates without page reload

            prevMonthButton.addEventListener('click', () => {
                if (currentMonthIndex === 0) {
                    currentMonthIndex = 11; // December
                    currentYearValue -= 1;
                } else {
                    currentMonthIndex -= 1;
                }
                updateCalendar();
            });

            nextMonthButton.addEventListener('click', () => {
                if (currentMonthIndex === 11) {
                    currentMonthIndex = 0; // January
                    currentYearValue += 1;
                } else {
                    currentMonthIndex += 1;
                }
                updateCalendar();
            });
        });
    </script>
    <!-- Log out button -->
    <script>
        function isUserAuthenticated() {
                return !!sessionStorage.getItem('authToken'); // Example check
                        }

        if (!isUserAuthenticated()) {
                window.location.href = 'http://localhost:3000/'; // Change this to your desired URL
                }

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                // Clear all items from local storage and session storage
                localStorage.clear();
                sessionStorage.clear();
    
                // Show SweetAlert confirmation
                await Swal.fire({
                    title: 'Logged Out',
                    text: 'You have been successfully logged out.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
    
                // Redirect to login page or home page
                window.location.href = 'http://localhost:3000/'; // Change this to your desired URL
            } catch (error) {
                console.error('Error logging out:', error);
    
                // Show SweetAlert error message
                Swal.fire({
                    title: 'Logout Failed',
                    text: 'An error occurred while logging out. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    
        // Optional: Prevent navigation back to the protected page
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Redirect to the login page if the user tries to go back
                window.location.href = 'http://localhost:3000/'; // Change this to your desired URL
            }
        });
    </script>
    <!-- mobile Log out button -->
    <script>
        document.getElementById('mobile-logout').addEventListener('click', async () => {
            try {

                // Clear all items from local storage and session storage
                localStorage.clear();
                sessionStorage.clear();
                // Show SweetAlert confirmation
                await Swal.fire({
                    title: 'Logged Out',
                    text: 'You have been successfully logged out.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                // Redirect to login page or home page
                window.location.href = 'http://localhost:3000/'; // Change this to your desired URL
            } catch (error) {
                console.error('Error logging out:', error);

                // Show SweetAlert error message
                Swal.fire({
                    title: 'Logout Failed',
                    text: 'An error occurred while logging out. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    </script>
    <!-- Check logged in user -->
    <script>
        // Function to check if there's a logged-in account
        function checkLoginStatus() {
            // Check sessionStorage for a logged-in user
            let sessionUser = sessionStorage.getItem('userPhone');

            // Check localStorage for a logged-in user
            let localUser = localStorage.getItem('userPhone');

            // If user exists in sessionStorage or localStorage, return the user's info
            if (sessionUser) {
                console.log('User is logged in via session storage:', sessionUser);
                return sessionUser;
            } else if (localUser) {
                console.log('User is logged in via local storage:', localUser);
                return localUser;
            } else {
                console.log('No user is logged in.');
                return null;
            }
        }

        // Example usage
        let loggedInUser = checkLoginStatus();
        if (loggedInUser) {
            // User is logged in, proceed with logged-in logic
            console.log('Logged in as:', loggedInUser);
        } else {
            // No user is logged in, show Swal alert and then redirect to login
            Swal.fire({
                icon: 'warning',
                title: 'No user logged in',
                text: 'You will be redirected to the login page.',
                confirmButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear all items from local storage and session storage
                    localStorage.clear();
                    sessionStorage.clear();
                    // Redirect to login page after user clicks "OK"
                    window.location.href = 'http://localhost:3000/';
                }
            });
        }
    </script>
</body>
</html>
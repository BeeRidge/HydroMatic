<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Edit Landing Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap');
        .font-family-karla { font-family: 'Poppins', sans-serif; }
        .bg-body { background: #1f272b; }
        .text1 { color: #15cc15; }
        .textarea { resize: vertical; min-height: 150px; }
        .content-editable { border: 1px solid #ccc; padding: 10px; min-height: 150px; }
        .image-preview { max-width: 100%; height: auto; }
    </style>
</head>
<body class="bg-body text-black font-family-karla">
    <div class="container mx-auto p-6">
        <h1 class="text-5xl text1 font-bold mb-8">HYDROMATIC CMS</h1>

        <div id="admin-content" class="space-y-6">
            <!-- Content will be inserted here by JavaScript -->
        </div>
    </div>  

    <script>
        async function fetchAdminContent() {
            try {
                const response = await fetch('http://localhost:3000/api/admin-content');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log(data);
                renderAdminContent(data);
            } catch (error) {
                console.error('Error fetching content:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to fetch content. Please try again.',
                    confirmButtonText: 'OK'
                });
            }
        }

        function renderAdminContent(data) {
            const adminContentDiv = document.getElementById('admin-content');
            adminContentDiv.innerHTML = ''; // Clear existing content

            data.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.classList.add('card', 'p-6', 'bg-gray-100', 'rounded-lg');

                // Create a container for editable content
                const contentContainer = document.createElement('div');
                contentContainer.classList.add('content-editable');
                contentContainer.contentEditable = true;
                contentContainer.innerHTML = section.content || '<p>No content available</p>'; // Fallback

                // Create a textarea
                const contentTextarea = document.createElement('textarea');
                contentTextarea.classList.add('textarea', 'w-full', 'bg-white', 'border', 'border-gray-300', 'p-2');
                contentTextarea.value = section.content || ''; // Set the initial value

                // Create an image preview
                const imagePreview = document.createElement('img');
                imagePreview.src = section.image_url || ''; // Set initial image URL
                imagePreview.classList.add('image-preview', 'my-4');
                imagePreview.alt = 'Image preview';

                // Create an image upload input
                const imageUploadInput = document.createElement('input');
                imageUploadInput.type = 'file';
                imageUploadInput.accept = 'image/*';
                imageUploadInput.classList.add('mt-2');

                // Add event listener for image upload
                imageUploadInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('image', file);

                        try {
                            const uploadResponse = await fetch('http://localhost:3000/api/upload-image', {
                                method: 'POST',
                                body: formData
                            });
                            if (!uploadResponse.ok) {
                                throw new Error('Image upload failed');
                            }
                            const uploadData = await uploadResponse.json();
                            imagePreview.src = uploadData.imageUrl; // Update preview
                            Swal.fire({
                                icon: 'success',
                                title: 'Image uploaded successfully!',
                                text: 'The image has been updated.',
                                confirmButtonText: 'OK'
                            });
                        } catch (error) {
                            console.error('Error uploading image:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Upload failed',
                                text: 'There was an error uploading the image. Please try again.',
                                confirmButtonText: 'OK'
                            });
                        }
                    }
                });

                sectionDiv.innerHTML = `
                    <div class="section-header">
                        <h3 class="text-2xl font-semibold text-gray-800">${section.section_name}</h3>
                    </div>
                `;
                sectionDiv.appendChild(contentContainer);
                sectionDiv.appendChild(contentTextarea);
                sectionDiv.appendChild(imagePreview);
                sectionDiv.appendChild(imageUploadInput);

                // Add update button
                const updateButton = document.createElement('button');
                updateButton.textContent = 'Update';
                updateButton.classList.add('mt-4', 'bg-green-500', 'text-white', 'px-6', 'py-3', 'rounded-lg', 'hover:bg-green-700', 'transition', 'duration-300');
                updateButton.onclick = () => {
                    const content = contentTextarea.value;
                    updateContent(section.section_id, content);
                };
                sectionDiv.appendChild(updateButton);

                // Sync content between contentEditable div and textarea
                const syncContent = () => {
                    const currentContent = contentContainer.innerText;
                    contentTextarea.value = currentContent;
                };

                contentContainer.addEventListener('input', syncContent);
                contentTextarea.addEventListener('input', () => {
                    contentContainer.innerText = contentTextarea.value;
                });

                adminContentDiv.appendChild(sectionDiv);
            });
        }

        async function updateContent(section_id, content) {
            if (!section_id) {
                console.error('Section ID is missing or undefined');
                return;
            }

            console.log("Updating content with Section ID:", section_id);

            try {
                const response = await fetch(`http://localhost:3000/admin/content/${section_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content }),
                });

                if (!response.ok) {
                    const errorText = await response.text(); // Get the error response text
                    throw new Error(`Network response was not ok: ${errorText}`);
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Content updated successfully!',
                    text: 'Your changes have been saved.',
                    confirmButtonText: 'OK'
                });
                fetchAdminContent(); // Refresh content after update
            } catch (error) {
                console.error('Error updating content:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Update failed',
                    text: 'There was an error updating the content. Please try again.',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Fetch content on page load
        fetchAdminContent();
    </script>
</body>
</html>

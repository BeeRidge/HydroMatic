<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HydroMatic ADMIN</title>
    <link rel="icon" href="/img/Logo.png" type="image/x-icon">
    <meta name="author" content="name">
    <meta name="description" content="description here">
    <meta name="keywords" content="keywords,here">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" />
    <!--Replace with your tailwind.css once created-->

</head>
<style>
    .font-family-karla {
        font-family: 'Poppins', sans-serif;
    }

    .bg-body {
        background: #1f272b;
    }

    .text1 {
        color: #15cc15;
    }

    .text2 {
        color: #FFFF;
    }

    .text-combined {
        display: inline-block;
        font-weight: 700;
    }

    /* Custom colors for teal, cyan, and sky */
    .bg-sky-custom {
        background-color: #007aaa;
        /* Light sky blue */
    }
</style>

<body class="bg-gray-800 font-sans leading-normal tracking-normal mt-12">

    <header>
        <!--Nav-->
        <nav aria-label="menu nav" class="bg-gray-800 pt-2 md:pt-1 pb-1 px-4 mt-0 h-auto fixed w-full z-20 top-0">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <div class="w-16 h-16">
                        <img src="/img/Logo.png" alt="HydroMatic Logo">
                    </div>
                    <a href="admin-main"
                        class="text-2xl md:text-3xl lg:text-4xl xl:text-5xl uppercase font-family-karla hover:text-green-100 text-combined">
                        <span class="text2">Hydro</span><span class="text1">Matic</span> <span
                            class="text2">ADMIN</span>
                    </a>
                </div>
                <!-- Logout Button Positioned to the Right -->
                <button id="logout-button" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                    Logout
                </button>
            </div>
        </nav>
    </header>



    <main>
        <div class="flex mt-20 px-1 flex-col md:flex-row">
            <nav aria-label="alternative nav">
                <div
                    class="bg-gray-800 h-20 fixed bottom-0 mt-12 md:relative md:h-screen z-10 w-full md:w-48 content-center">
                    <div
                        class="md:mt-12 md:w-48 md:fixed md:left-0 md:top-0 content-center md:content-start text-left justify-between">
                        <ul
                            class="list-reset flex flex-row md:flex-col pt-3 md:py-3 px-1 md:px-2 text-center md:text-left">
                            <li class="mr-3 flex-1">
                                <a href="admin-main"
                                    class="block py-1 md:py-3 pl-1 align-middle text-white no-underline hover:text-white border-b-2 border-gray-800 hover:border-green-500">
                                    <span
                                        class="pb-1 md:pb-0 text-xs md:text-base text-white md:text-white block md:inline-block">Dashboard</span>
                                </a>
                            </li>
                            <li class="mr-3 flex-1">
                                <a href="admin-cms"
                                    class="block py-1 md:py-3 pl-1 align-middle text-white no-underline hover:text-white border-b-2 border-gray-800 hover:border-green-500">
                                    <span
                                        class="pb-1 md:pb-0 text-xs md:text-base text-gray-400 md:text-gray-200 block md:inline-block">CMS</span>
                                </a>
                            </li>
                            <li class="mr-3 flex-1"></li>
                            <a href="admin-user"
                                class="block py-1 md:py-3 pl-1 align-middle text-white no-underline hover:text-white border-b-2 border-blue-600">
                                <span
                                    class="pb-1 md:pb-0 text-xs md:text-base text-gray-400 md:text-gray-200 block md:inline-block">Manage
                                    User Account</span>
                            </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <section class="w-full h-full flex">
                <div id="main" class="w-full main-content flex-1 bg-gray-100 mt-12 md:mt-2 pb-24 md:pb-5">
                    <div class="bg-gray-800">
                        <div
                            class="rounded-tl-3xl bg-gradient-to-r from-blue-900 to-gray-800 p-4 shadow text-2xl text-white">
                            <h1 class="font-bold pl-2">User Accounts Management</h1>
                        </div>
                    </div>
                    <div class="w-full shadow-lg p-6 bg-gray-200">
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">User Account</h1>
                        <div class="mb-4">
                            <input type="text" id="searchInput"
                                placeholder="Search by First Name, Last Name, or Phone Number"
                                class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" />
                        </div>
                        <table id="newUserTable"
                            class="w-full divide-y divide-gray-300 rounded-lg shadow-lg overflow-hidden">
                            <thead class="bg-sky-custom text-white">
                                <tr>
                                    <th
                                        class="px-6 py-4 border-b-2 border-gray-300 text-left text-sm font-semibold uppercase tracking-wider">
                                        First Name</th>
                                    <th
                                        class="px-6 py-4 border-b-2 border-gray-300 text-left text-sm font-semibold uppercase tracking-wider">
                                        Last Name</th>
                                    <th
                                        class="px-6 py-4 border-b-2 border-gray-300 text-left text-sm font-semibold uppercase tracking-wider">
                                        Phone Number</th>
                                    <th
                                        class="px-6 py-4 border-b-2 border-gray-300 text-left text-sm font-semibold uppercase tracking-wider">
                                        Date</th>
                                    <th
                                        class="px-6 py-4 border-b-2 border-gray-300 text-left text-sm font-semibold uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="newUserBody">
                                <!-- Data will be inserted here by JavaScript -->
                            </tbody>
                        </table>

                        <div id="pagination" class="flex items-center justify-center mt-4">
                            <button id="prevNewUserBtn"
                                class="px-4 py-2 bg-sky-custom text-lg text-white rounded-lg shadow-lg hover:bg-sky-custom mr-2">Previous</button>
                            <span id="newUserPageIndicator" class="text-lg text-gray-600 mx-2"></span>
                            <button id="nextNewUserBtn"
                                class="px-4 py-2 bg-sky-custom text-lg text-white rounded-lg shadow-lg hover:bg-sky-custom ml-2">Next</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Variables for New Users
        let newUsers = [];
        let filteredUsers = [];
        let curPageNewUsers = 1;
        const itemPerPage = 10;

        // Function to fetch new user data
        async function fetchNewUserData() {
            try {
                const response = await fetch('/api/admin/new-users');
                const data = await response.json();

                if (data.success) {
                    newUsers = data.users;
                    filteredUsers = newUsers; // Set filtered users to the full list initially
                    displayNewUserPage(curPageNewUsers);
                } else {
                    console.error('Failed to fetch new user data:', data.error);
                }
            } catch (err) {
                console.error('Error fetching new user data:', err);
            }
        }

        // Function to display new users on the page
        function displayNewUserPage(page) {
            const newUserBody = document.getElementById('newUserBody');
            newUserBody.innerHTML = '';

            const start = (page - 1) * itemPerPage;
            const end = start + itemPerPage;
            const paginatedUsers = filteredUsers.slice(start, end);

            paginatedUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 text-left">${user.Acc_Fname}</td>
                    <td class="px-6 py-4 text-left">${user.Acc_Lname}</td>
                    <td class="px-6 py-4 text-left">${user.Acc_Pnumber}</td>
                    <td class="px-6 py-4 text-left">${new Date(user.Date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-left">
                        <button class="editBtn px-4 py-2 bg-yellow-500 text-white rounded-lg shadow-lg hover:bg-yellow-600" data-id="${user.Acc_Pnumber}">Edit</button>
                    </td>
                `;
                newUserBody.appendChild(row);
            });

            document.getElementById('newUserPageIndicator').textContent = `Page ${page} of ${Math.ceil(filteredUsers.length / itemPerPage)}`;
            document.getElementById('prevNewUserBtn').disabled = page === 1;
            document.getElementById('nextNewUserBtn').disabled = page === Math.ceil(filteredUsers.length / itemPerPage);

            // Attach event listeners to the edit buttons
            document.querySelectorAll('.editBtn').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.getAttribute('data-id');
                    openEditModal(userId);
                });
            });
        }

        // Function to open the edit modal using SweetAlert for a user
        function openEditModal(userId) {
            const user = newUsers.find(u => u.Acc_Pnumber === userId);

            console.log("Opening edit modal for user:", user); // Debugging log

            if (user) {
                Swal.fire({
                    title: 'Edit User Details',
                    html: `
                        <input type="text" id="swal-input-fname" class="swal2-input" placeholder="First Name" value="${user.Acc_Fname}">
                        <input type="text" id="swal-input-lname" class="swal2-input" placeholder="Last Name" value="${user.Acc_Lname}">
                        <input type="text" id="swal-input-pnumber" class="swal2-input" placeholder="Phone Number" value="${user.Acc_Pnumber}">
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Save',
                    cancelButtonText: 'Cancel',
                    preConfirm: () => {
                        const newFname = document.getElementById('swal-input-fname').value;
                        const newLname = document.getElementById('swal-input-lname').value;
                        const newPnumber = document.getElementById('swal-input-pnumber').value;

                        if (!newFname || !newLname || !newPnumber) {
                            Swal.showValidationMessage('All fields are required');
                            return false;
                        }

                        return { newFname, newLname, newPnumber };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const { newFname, newLname, newPnumber } = result.value;
                        updateUser(userId, newFname, newLname, newPnumber);
                    }
                });
            } else {
                console.error("User not found for ID:", userId); // Error log if user not found
            }
        }

        // Function to update user details on the server
        async function updateUser(userId, newFname, newLname, newNumber) {
            console.log("Updating user:", userId, newFname, newLname, newNumber); // Log update action
            try {
                const response = await fetch(`/api/admin/update-user/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Acc_Fname: newFname,
                        Acc_Lname: newLname,
                        Acc_Pnumber: newNumber
                    }),
                });

                const result = await response.json();
                if (result.success) {
                    // Update the local data and re-render the table
                    const userIndex = newUsers.findIndex(u => u.Acc_Pnumber === userId);
                    if (userIndex > -1) {
                        newUsers[userIndex].Acc_Fname = newFname;
                        newUsers[userIndex].Acc_Lname = newLname;
                        newUsers[userIndex].Acc_Pnumber = newNumber;
                        displayNewUserPage(curPageNewUsers); // Refresh the displayed data

                        // Show SweetAlert success message
                        Swal.fire({
                            title: 'Success',
                            text: 'User details updated successfully!',
                            icon: 'success',
                            confirmButtonText: 'OK',
                        });
                    }
                } else {
                    console.error("Failed to update user:", result.error);
                    Swal.fire('Error', 'Failed to update user details. Please try again.', 'error');
                }
            } catch (err) {
                console.error("Error updating user:", err);
                Swal.fire('Error', 'An error occurred while updating user details.', 'error');
            }
        }

        // Fetch initial data
        fetchNewUserData();
    </script>


</body>

</html>